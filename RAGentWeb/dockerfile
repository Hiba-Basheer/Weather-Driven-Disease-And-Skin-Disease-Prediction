# RUNTIME STAGE
FROM python:3.12-slim
WORKDIR /app

# Install runtime deps 
RUN apt-get update && apt-get install -y --no-install-recommends \
    libgomp1 libjpeg62-turbo zlib1g curl ca-certificates \
    && rm -rf /var/lib/apt/lists/*

# Install requirements
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# Copy source
COPY src/ src/
COPY static/ static/
COPY templates/ templates/
COPY data/vector_store/ data/vector_store/
COPY models/ml/ models/ml/
COPY models/dl/ models/dl/
COPY models/class_labels.txt models/class_labels.txt

# DOWNLOAD REAL 225MB MODEL FROM GITHUB RAW
RUN mkdir -p models && \
    curl -L -o models/resnet_model.h5 \
    "https://raw.githubusercontent.com/Hiba-Basheer/Weather-Driven-Disease-And-Skin-Disease-Prediction/main/RAGentWeb/models/resnet_model.h5" && \
    echo "MODEL VERIFICATION" && \
    ls -lh models/resnet_model.h5 && \
    head -c 10 models/resnet_model.h5 | xxd | grep -i "48 44 46" && \
    echo "HDF5 signature found (0x48 44 46...)"

# Environment
ENV PYTHONUNBUFFERED=1 \
    TF_CPP_MIN_LOG_LEVEL=2 \
    FAISS_PATH=/app/data/vector_store/faiss_index \
    PYTHONPATH=/app

# User
RUN useradd -m -s /bin/bash appuser && chown -R appuser:appuser /app
USER appuser

EXPOSE 8000

CMD ["uvicorn", "src.main:app", "--host", "0.0.0.0", "--port", "8000", "--log-level", "info"]