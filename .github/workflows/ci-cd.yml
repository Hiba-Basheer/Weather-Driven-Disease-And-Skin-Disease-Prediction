# .github/workflows/ci-cd.yml
name: CI/CD â†’ GCP Cloud Run

on:
  push:
    branches: [ main ]
    paths:
      - 'RAGentWeb/**'
  pull_request:

jobs:
  quality:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./RAGentWeb
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      - run: pip install ruff black mypy bandit isort
      - run: pip install -r requirements.txt
      - run: ruff check src/ tests/
      - run: black --check src/ tests/
      - run: isort --check-only src/ tests/
      - run: mypy src/
      - run: bandit -r src/

  test:
    needs: quality
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./RAGentWeb
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      - run: pip install pytest pytest-asyncio fastapi[all] pillow
      - run: pytest -vv --asyncio-mode=auto

  deploy:
    needs: test
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./RAGentWeb
    permissions:
      contents: read
      id-token: write

    steps:
      - uses: actions/checkout@v4

      # Authenticate with GCP via Workload Identity Federation
      - uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: "projects/43780674799/locations/global/workloadIdentityPools/github-pool/providers/github-provider"
          service_account: "github-deployer@western-plate-475306-m0.iam.gserviceaccount.com"

      # Set up Google Cloud SDK
      - uses: google-github-actions/setup-gcloud@v2

      # Configure Docker for Artifact Registry
      - run: gcloud auth configure-docker asia-south1-docker.pkg.dev --quiet

      # Build and push Docker image to Artifact Registry
      - run: |
          IMAGE="asia-south1-docker.pkg.dev/western-plate-475306-m0/ragentweb-repo/ragentweb:latest"
          docker build -t "$IMAGE" -f Dockerfile .
          docker push "$IMAGE"

      # Deploy to Cloud Run
      - run: |
          gcloud run deploy rag-web \
            --image "$IMAGE" \
            --platform managed \
            --region asia-south1 \
            --allow-unauthenticated \
            --port 8000 \
            --set-env-vars OPENWEATHERMAP_API_KEY=${{ secrets.OPENWEATHERMAP_API_KEY }},GROQ_API_KEY=${{ secrets.GROQ_API_KEY }} \
            --quiet
